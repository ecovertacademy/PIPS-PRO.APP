<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>PIPS Pro‚Ñ¢ ¬∑ Property Inspection Profit System (Phase 1)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* EXQUISITE DESIGN ‚Äì same as before */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            background: #f0f4f8;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }
        #app {
            max-width: 480px;
            width: 100%;
            background: white;
            border-radius: 36px 36px 24px 24px;
            box-shadow: 0 20px 40px rgba(0, 31, 63, 0.25);
            overflow: hidden;
            border: 1px solid rgba(255,215,0,0.3);
            position: relative;
            background-image: linear-gradient(145deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.98) 100%),
                              url('https://images.unsplash.com/photo-1514924013411-cbf25faa35bb?w=800');
            background-size: cover;
            background-blend-mode: overlay;
        }
        .header {
            background: rgba(11, 28, 63, 0.95);
            color: white;
            padding: 20px 20px 12px;
            backdrop-filter: blur(2px);
            border-bottom: 3px solid #FFD700;
        }
        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }
        .header h1 span {
            color: #FFD700;
            font-weight: 300;
            font-size: 1rem;
            display: block;
        }
        .header .byline {
            font-size: 0.85rem;
            color: #b0c4de;
            margin-top: 4px;
            border-left: 3px solid #FFD700;
            padding-left: 10px;
        }
        .screen-container {
            padding: 20px 16px 80px;
            min-height: 500px;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(4px);
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background: rgba(11, 28, 63, 0.98);
            padding: 8px 4px 12px;
            border-top: 2px solid #FFD700;
            position: sticky;
            bottom: 0;
            width: 100%;
        }
        .nav-item {
            color: #a0b9d4;
            text-align: center;
            font-size: 0.7rem;
            transition: all 0.1s;
            flex: 1;
            padding: 6px 0;
            border-radius: 20px;
            cursor: pointer;
        }
        .nav-item i {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 2px;
            color: #a0b9d4;
        }
        .nav-item.active {
            color: #FFD700;
            background: rgba(255,215,0,0.1);
        }
        .nav-item.active i {
            color: #FFD700;
        }
        .btn {
            background: #0B1C3F;
            border: none;
            color: white;
            padding: 14px 18px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin: 8px 0;
            border: 1px solid #FFD700;
            box-shadow: 0 4px 6px rgba(0,31,63,0.3);
            cursor: pointer;
        }
        .btn-secondary {
            background: #7C9EB2;
            border-color: #0B1C3F;
        }
        .btn-gold {
            background: #FFD700;
            color: #0B1C3F;
            border: 1px solid #0B1C3F;
        }
        .card {
            background: white;
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 10px rgba(0,31,63,0.1);
            border-left: 6px solid #FFD700;
        }
        input, textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #7C9EB2;
            border-radius: 40px;
            font-size: 1rem;
            margin: 8px 0;
            background: rgba(255,255,255,0.9);
        }
        label {
            font-weight: 600;
            color: #0B1C3F;
            margin-left: 8px;
        }
        .protocol-item {
            background: rgba(124,158,178,0.1);
            border-radius: 20px;
            padding: 12px 16px;
            margin: 6px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #7C9EB2;
            cursor: pointer;
        }
        .protocol-item.free {
            border-left: 6px solid #FFD700;
        }
        .protocol-item.locked {
            opacity: 0.75;
            background: #e0e7ed;
        }
        .protocol-badge {
            background: #FFD700;
            color: #0B1C3F;
            border-radius: 40px;
            padding: 4px 12px;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .tier-badge {
            background: #0B1C3F;
            color: #FFD700;
            border-radius: 20px;
            padding: 2px 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 8px;
        }
        .photo-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        .photo-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 16px;
            border: 2px solid #FFD700;
            position: relative;
        }
        .photo-thumb-container {
            position: relative;
            display: inline-block;
        }
        .annotate-btn {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(11,28,63,0.8);
            color: #FFD700;
            font-size: 0.6rem;
            text-align: center;
            border-radius: 0 0 16px 16px;
            cursor: pointer;
        }
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: 0.2s;
        }
        .modal.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background: white;
            max-width: 90%;
            width: 400px;
            padding: 20px;
            border-radius: 48px;
            border: 4px solid #FFD700;
            max-height: 80vh;
            overflow-y: auto;
        }
        .annotation-modal {
            width: 90%;
            max-width: 800px;
            background: #222;
        }
        #annotation-canvas {
            width: 100%;
            background: #333;
            border: 2px solid #FFD700;
            border-radius: 16px;
            cursor: crosshair;
        }
        .toolbar {
            display: flex;
            gap: 8px;
            margin: 8px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tool-btn {
            background: #0B1C3F;
            color: #FFD700;
            border: 1px solid #FFD700;
            padding: 8px 16px;
            border-radius: 40px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .tool-btn.active {
            background: #FFD700;
            color: #0B1C3F;
        }
        .dimension-rating {
            background: #f0f4fa;
            border-radius: 16px;
            padding: 12px;
            margin: 12px 0;
        }
        .rating-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 6px 0;
        }
        .rating-item input {
            width: 70px;
            margin-left: 10px;
            padding: 8px;
            border-radius: 20px;
        }
        #login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 500px;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="header">
        <h1>PIPS Pro‚Ñ¢ <span>Property Inspection Profit System</span></h1>
        <div class="byline">By Ali Sekhr ¬∑ London‚ÄìDubai</div>
    </div>

    <div class="screen-container" id="screenContainer">
        <!-- LOGIN SCREEN -->
        <div id="login-screen" class="screen active">
            <div class="card" style="background: rgba(255,255,255,0.8);">
                <h2 style="color:#0B1C3F; margin-bottom:20px;"><i class="fas fa-clipboard-check" style="color:#FFD700;"></i> Inspect with PIPS</h2>
                <input type="email" id="login-email" placeholder="Email" value="demo@example.com">
                <input type="password" id="login-password" placeholder="Password" value="password">
                <button class="btn" id="login-btn"><i class="fas fa-sign-in-alt"></i> Log In</button>
                <p style="text-align:center; margin:10px;">or</p>
                <button class="btn btn-secondary" id="register-btn"><i class="fas fa-user-plus"></i> Register</button>
                <p style="font-size:0.8rem; margin-top:20px;">Demo: any email/password (localStorage)</p>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard-screen" class="screen">
            <div class="card">
                <h3>Welcome back, <span id="user-name">Inspector</span> üëã</h3>
                <p style="color:#0B1C3F;"><i class="fas fa-chart-line" style="color:#FFD700;"></i> This month: <span id="month-count">0</span> inspections</p>
            </div>
            <div class="card">
                <h4>Quick actions</h4>
                <button class="btn btn-gold" id="quick-new"><i class="fas fa-camera"></i> New Inspection</button>
                <button class="btn btn-secondary" id="quick-reports"><i class="fas fa-file-pdf"></i> Recent Reports</button>
            </div>
            <div class="card">
                <h4>Recent inspections</h4>
                <ul id="recent-list" style="list-style:none;">
                    <li>Loading...</li>
                </ul>
            </div>
        </div>

        <!-- PROTOCOLS LIBRARY (list + detail) -->
        <div id="protocols-screen" class="screen">
            <div id="protocols-list-view">
                <h3 style="color:#0B1C3F;">üìã Protocol Library</h3>
                <p style="font-size:0.9rem;">First 3 free ¬∑ <i class="fas fa-crown" style="color:#FFD700;"></i> Upgrade to Pro for full access</p>
                <div id="protocol-list" class="protocol-list"></div>
            </div>
            <div id="protocol-detail-view" style="display: none;">
                <button class="back-btn" id="back-to-protocols"><i class="fas fa-arrow-left"></i> Back to library</button>
                <div id="protocol-detail-content"></div>
            </div>
        </div>

        <!-- NEW INSPECTION (with rating and annotation) -->
        <div id="new-inspection-screen" class="screen">
            <h3 style="color:#0B1C3F;">üè† New Inspection</h3>
            <div class="card">
                <label>Property address</label>
                <input type="text" id="prop-address" placeholder="e.g., 123 Main St">
                <label>Property type</label>
                <select id="prop-type">
                    <option>House</option>
                    <option>Apartment</option>
                    <option>Commercial</option>
                </select>
                <label>Size (sq ft)</label>
                <input type="number" id="prop-size" placeholder="2000">
                <label>Age (years)</label>
                <input type="number" id="prop-age" placeholder="15">
                <label>Select protocol</label>
                <select id="inspection-protocol"></select>
                
                <!-- Rating section (dynamic) -->
                <div id="rating-section" style="margin-top: 20px;"></div>

                <label>Photos <small>(tap to add, max 3 per dimension)</small></label>
                <input type="file" id="photo-input" accept="image/*" capture="camera" multiple>
                <div class="photo-grid" id="photo-preview"></div>

                <button class="btn btn-gold" id="generate-report-btn"><i class="fas fa-file-pdf"></i> Generate Report & Save</button>
            </div>
        </div>

        <!-- REPORTS -->
        <div id="reports-screen" class="screen">
            <h3 style="color:#0B1C3F;">üìÅ Inspection Reports</h3>
            <div id="reports-list"></div>
        </div>

        <!-- PROFILE (simplified, no white‚Äëlabel/team) -->
        <div id="profile-screen" class="screen">
            <div class="card">
                <h4><i class="fas fa-user-circle"></i> Inspector Profile</h4>
                <p><strong>Email:</strong> <span id="profile-email"></span></p>
                <p><strong>Subscription Tier:</strong> <span id="sub-tier">Freemium (3 protocols)</span></p>
                <p><small>Upgrades coming soon ‚Äì stay tuned!</small></p>
                <button class="btn btn-secondary" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Log out</button>
            </div>
            <div class="card">
                <p style="text-align:center;">üöÄ ‚ÄúProperty Inspection Profit System‚Ñ¢‚Äù<br>By Ali Sekhr</p>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAV (5 screens) -->
    <div class="bottom-nav" id="bottom-nav" style="display: none;">
        <div class="nav-item" data-screen="dashboard"><i class="fas fa-home"></i>Home</div>
        <div class="nav-item" data-screen="protocols"><i class="fas fa-book"></i>Protocols</div>
        <div class="nav-item" data-screen="new-inspection"><i class="fas fa-plus-circle"></i>New</div>
        <div class="nav-item" data-screen="reports"><i class="fas fa-file-alt"></i>Reports</div>
        <div class="nav-item" data-screen="profile"><i class="fas fa-user"></i>Profile</div>
    </div>
</div>

<!-- UPGRADE MODAL (simple placeholder ‚Äì no Stripe yet) -->
<div id="upgrade-modal" class="modal">
    <div class="modal-content">
        <h3 style="color:#0B1C3F;">üîí Protocol Locked</h3>
        <p>This protocol is available in Pro tier. Upgrade to access all 38 protocols.</p>
        <button class="btn btn-gold" id="modal-upgrade">Upgrade (coming soon)</button>
        <button class="btn" id="modal-close">Close</button>
    </div>
</div>

<!-- ANNOTATION MODAL (unchanged) -->
<div id="annotation-modal" class="modal">
    <div class="modal-content annotation-modal" style="background:#2d2d2d; color:white;">
        <h3 style="color:#FFD700;">Annotate Photo</h3>
        <canvas id="annotation-canvas" width="400" height="300"></canvas>
        <div class="toolbar">
            <button class="tool-btn" id="tool-rect">Rectangle</button>
            <button class="tool-btn" id="tool-circle">Circle</button>
            <button class="tool-btn" id="tool-text">Text</button>
            <button class="tool-btn" id="tool-save">Save & Close</button>
            <button class="tool-btn" id="tool-cancel">Cancel</button>
        </div>
        <p style="font-size:0.8rem; margin-top:8px;">Rect: red, Circle: blue, Text: white. Click to draw.</p>
    </div>
</div>

<script>
(function() {
    // ==================== CONFIG ====================
    const API_BASE = 'https://your-backend.com/api';  // Replace with your Phase 1 backend URL
    const USE_REAL_API = false; // Set to true when backend is ready

    // ==================== MOCK DATA & LOCALSTORAGE FALLBACK ====================
    // Full 38 protocols (same as before ‚Äì keep embedded for demo)
    const protocolsData = [ /* ... insert the full 38 protocols array from previous answer ... */ ];
    // For brevity, we'll assume you have the full array. In practice, copy from the earlier message.
    // Mark first 3 as free
    const protocols = protocolsData.map(p => ({ ...p, free: p.id <= 3 }));

    // LocalStorage keys
    const STORAGE_USER = 'pips_user';
    const STORAGE_INSPECTIONS = 'pips_inspections';
    const STORAGE_TOKEN = 'pips_token';

    let currentUser = null;
    let inspections = [];
    let authToken = localStorage.getItem(STORAGE_TOKEN);

    function loadLocalData() {
        const userJson = localStorage.getItem(STORAGE_USER);
        if (userJson) currentUser = JSON.parse(userJson);
        const inspJson = localStorage.getItem(STORAGE_INSPECTIONS);
        inspections = inspJson ? JSON.parse(inspJson) : [];
    }
    function saveLocalData() {
        localStorage.setItem(STORAGE_USER, JSON.stringify(currentUser));
        localStorage.setItem(STORAGE_INSPECTIONS, JSON.stringify(inspections));
    }

    loadLocalData();

    // ==================== API CLIENT (stub) ====================
    const api = {
        async login(email, password) {
            if (USE_REAL_API) {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (!res.ok) throw new Error('Login failed');
                const data = await res.json();
                authToken = data.token;
                localStorage.setItem(STORAGE_TOKEN, authToken);
                return data.user;
            } else {
                // mock
                return { id: 1, email, name: email.split('@')[0], tier: 'freemium' };
            }
        },
        async register(email, password) {
            // similar
            return this.login(email, password);
        },
        async getProtocols() {
            if (USE_REAL_API) {
                const res = await fetch(`${API_BASE}/protocols/list`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                return res.json();
            } else {
                return protocols;
            }
        },
        async createAssessment(data) {
            if (USE_REAL_API) {
                const res = await fetch(`${API_BASE}/assessments/create`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return res.json();
            } else {
                const newId = inspections.length + 1;
                const assessment = { id: newId, ...data, userId: currentUser.id, status: 'in_progress', createdAt: new Date() };
                inspections.push(assessment);
                saveLocalData();
                return assessment;
            }
        },
        async saveRating(data) {
            if (USE_REAL_API) {
                await fetch(`${API_BASE}/assessments/saveRating`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                // store in localStorage ‚Äì we'll just keep in memory for demo
                console.log('Saved rating (local)', data);
            }
        },
        async getAssessment(id) {
            if (USE_REAL_API) {
                const res = await fetch(`${API_BASE}/assessments/get?id=${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                return res.json();
            } else {
                return inspections.find(a => a.id === id);
            }
        },
        // Photo upload: get pre-signed URL
        async getPhotoUploadUrl(assessmentId, dimensionId, fileName, contentType) {
            if (USE_REAL_API) {
                const res = await fetch(`${API_BASE}/photos/getUploadUrl`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assessmentId, dimensionId, fileName, contentType })
                });
                return res.json(); // { url, key }
            } else {
                // mock ‚Äì return fake signed URL
                return { url: '#', key: `mock/${fileName}` };
            }
        },
        async confirmPhotoUpload(assessmentId, dimensionId, s3Key) {
            if (USE_REAL_API) {
                await fetch(`${API_BASE}/photos/confirmUpload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assessmentId, dimensionId, s3Key })
                });
            } else {
                console.log('Photo confirmed (local)', { assessmentId, dimensionId, s3Key });
            }
        }
    };

    // ==================== UI STATE ====================
    let currentAssessmentId = null; // for new inspection
    let photosArray = []; // temporary for current dimension

    // ==================== RENDER FUNCTIONS (same as before) ====================
    function showScreen(screenId) { /* ... same as previous implementation ... */ }
    function updateProtocolsList() { /* ... same ... */ }
    function showProtocolDetail(protocolId) { /* ... same ... */ }
    function renderRatingSection(protocolId) { /* ... same ... */ }
    function collectRatings() { /* ... same ... */ }
    function updateDashboard() { /* ... same ... */ }
    function updateReportsList() { /* ... same ... */ }
    function updateProfile() { /* ... same ... */ }
    function populateProtocolSelect() { /* ... same ... */ }

    // ==================== PHOTO HANDLING WITH PRE-SIGNED URL ====================
    document.getElementById('photo-input').addEventListener('change', async function(e) {
        const preview = document.getElementById('photo-preview');
        preview.innerHTML = '';
        photosArray = [];
        const files = Array.from(e.target.files);
        // For demo, we'll limit to 3 photos
        for (let i = 0; i < Math.min(files.length, 3); i++) {
            const file = files[i];
            // 1. Get pre-signed URL from backend
            const { url, key } = await api.getPhotoUploadUrl(
                currentAssessmentId, 
                getCurrentDimensionId(), // need function to get current dimension
                file.name,
                file.type
            );
            // 2. Upload file directly to S3 (using fetch)
            // In real app: fetch(url, { method: 'PUT', body: file, headers: { 'Content-Type': file.type } })
            console.log(`Uploading ${file.name} to ${url}`);
            // 3. After success, confirm
            await api.confirmPhotoUpload(currentAssessmentId, getCurrentDimensionId(), key);
            
            // For preview, we'll use a local object URL
            const reader = new FileReader();
            reader.onload = (ev) => {
                const photoObj = { file, dataURL: ev.target.result, s3Key: key, annotatedDataURL: null };
                photosArray.push(photoObj);
                const container = document.createElement('div');
                container.className = 'photo-thumb-container';
                container.innerHTML = `<img src="${ev.target.result}" class="photo-thumb"><div class="annotate-btn" data-index="${i}">Annotate</div>`;
                preview.appendChild(container);
                container.querySelector('.annotate-btn').addEventListener('click', () => annotatePhoto(i));
            };
            reader.readAsDataURL(file);
        }
    });

    // Annotation modal logic (same as before, but after saving we should upload annotated version)
    function annotatePhoto(index) { /* ... same canvas setup ... */ }
    // After annotation, we would call api.getPhotoUploadUrl again for annotated version, then upload.

    // ==================== REPORT GENERATION (client-side) ====================
    function generatePDF(inspectionData, download = true) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFillColor(11, 28, 63);
        doc.rect(0, 0, 210, 30, 'F');
        doc.setTextColor(255, 215, 0);
        doc.setFontSize(16);
        doc.text('PIPS Pro‚Ñ¢', 105, 15, { align: 'center' });
        doc.setFontSize(10);
        doc.setTextColor(255,255,255);
        doc.text('Property Inspection Profit System', 105, 22, { align: 'center' });
        doc.setTextColor(0,0,0);
        doc.setFontSize(14);
        doc.text('Inspection Report', 20, 40);
        doc.setFontSize(11);
        doc.text(`Address: ${inspectionData.address || 'N/A'}`, 20, 50);
        doc.text(`Type: ${inspectionData.type || 'House'} | Size: ${inspectionData.size || '?'} sq ft | Age: ${inspectionData.age || '?'} years`, 20, 60);
        doc.text(`Protocol: ${inspectionData.protocolName || 'Standard'}`, 20, 70);
        doc.text(`Date: ${inspectionData.date || new Date().toLocaleDateString()}`, 20, 80);
        doc.text('Assessment Ratings:', 20, 100);
        if (inspectionData.ratings && inspectionData.ratings.length) {
            let y = 110;
            inspectionData.ratings.forEach((r, i) => {
                doc.text(`Item ${i+1}: ${r}/10`, 20, y);
                y += 7;
            });
        } else {
            doc.text('No ratings provided.', 20, 110);
        }
        doc.text(`Photos: ${inspectionData.photos ? inspectionData.photos.length : 0} captured`, 20, 200);
        doc.text('¬© Property Inspection Profit System‚Ñ¢ ¬∑ By Ali Sekhr', 105, 280, { align: 'center' });
        if (download) doc.save(`inspection_${Date.now()}.pdf`);
    }

    // ==================== EVENT LISTENERS ====================
    // Login / Register
    document.getElementById('login-btn').addEventListener('click', async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        try {
            const user = await api.login(email, pass);
            currentUser = user;
            localStorage.setItem(STORAGE_USER, JSON.stringify(user));
            showScreen('dashboard');
            updateDashboard();
            updateProtocolsList();
            updateReportsList();
            updateProfile();
            populateProtocolSelect();
        } catch (e) {
            alert('Login failed: ' + e.message);
        }
    });
    document.getElementById('register-btn').addEventListener('click', async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        try {
            const user = await api.register(email, pass);
            currentUser = user;
            localStorage.setItem(STORAGE_USER, JSON.stringify(user));
            showScreen('dashboard');
            updateDashboard();
            updateProtocolsList();
            updateReportsList();
            updateProfile();
            populateProtocolSelect();
        } catch (e) {
            alert('Registration failed: ' + e.message);
        }
    });

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            const screen = item.dataset.screen;
            showScreen(screen);
            if (screen === 'protocols') { updateProtocolsList(); document.getElementById('protocols-list-view').style.display = 'block'; document.getElementById('protocol-detail-view').style.display = 'none'; }
            if (screen === 'reports') updateReportsList();
            if (screen === 'profile') updateProfile();
            if (screen === 'new-inspection') { populateProtocolSelect(); photosArray = []; document.getElementById('photo-preview').innerHTML = ''; }
        });
    });

    document.getElementById('quick-new').addEventListener('click', () => showScreen('new-inspection'));
    document.getElementById('quick-reports').addEventListener('click', () => showScreen('reports'));
    document.getElementById('logout-btn').addEventListener('click', () => {
        currentUser = null;
        localStorage.removeItem(STORAGE_USER);
        localStorage.removeItem(STORAGE_TOKEN);
        showScreen('login');
    });

    // Generate report button
    document.getElementById('generate-report-btn').addEventListener('click', async () => {
        const address = document.getElementById('prop-address').value;
        const type = document.getElementById('prop-type').value;
        const size = document.getElementById('prop-size').value;
        const age = document.getElementById('prop-age').value;
        const protocolId = parseInt(document.getElementById('inspection-protocol').value);
        const protocol = protocols.find(p => p.id === protocolId);
        // Check if allowed (freemium first 3)
        if (!protocol.free) {
            alert('This protocol is locked in Freemium. Upgrade to Pro to use it.');
            return;
        }
        const ratings = collectRatings();
        // Create assessment via API
        const assessmentData = {
            propertyAddress: address,
            propertyType: type,
            inspectionDate: new Date().toISOString(),
            // include ratings, photos etc.
        };
        const newAssessment = await api.createAssessment(assessmentData);
        // Save ratings one by one (or batch)
        // ...
        // Generate PDF locally
        const inspection = {
            address, type, size, age,
            protocolName: protocol.name,
            date: new Date().toLocaleDateString(),
            ratings,
            photos: photosArray.map(p => p.s3Key) // just keys
        };
        generatePDF(inspection, true);
        // Update local list
        inspections.push({ ...inspection, id: newAssessment.id });
        saveLocalData();
        updateDashboard();
        updateReportsList();
        // Clear form
        document.getElementById('prop-address').value = '';
        document.getElementById('photo-preview').innerHTML = '';
        document.getElementById('rating-section').innerHTML = '';
        alert('Inspection saved and PDF generated.');
    });

    // Upgrade modal (placeholder)
    const upgradeModal = document.getElementById('upgrade-modal');
    document.getElementById('modal-close').addEventListener('click', () => upgradeModal.classList.remove('show'));
    document.getElementById('modal-upgrade').addEventListener('click', () => {
        alert('Upgrade coming soon!');
        upgradeModal.classList.remove('show');
    });

    // Protocol lock handling
    window.showPurchaseModal = (protocolId, protocolName) => {
        upgradeModal.classList.add('show');
    };

    // Initialize
    if (currentUser) {
        showScreen('dashboard');
        updateDashboard();
        updateProtocolsList();
        updateReportsList();
        updateProfile();
        populateProtocolSelect();
    } else {
        showScreen('login');
    }
})();
</script>
<!-- Add after the bottom-nav div, before closing </body> -->
<div style="text-align: center; padding: 10px; font-size: 0.8rem; background: rgba(255,255,255,0.5); margin-top: 10px;">
    <a href="/privacy.html" style="color: #0B1C3F; margin: 0 10px; text-decoration: none;">Privacy Policy</a> |
    <a href="/terms.html" style="color: #0B1C3F; margin: 0 10px; text-decoration: none;">Terms of Service</a> |
    <a href="/refund.html" style="color: #0B1C3F; margin: 0 10px; text-decoration: none;">Refund Policy</a>
    <p style="margin-top: 5px; color: #666;">¬© 2026 Property Inspection Profit System‚Ñ¢ ¬∑ By Ali Sekhr</p>
</div>
</body>
</html>
